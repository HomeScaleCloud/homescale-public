name: "Build"
permissions:
  contents: read
  packages: write
  id-token: write


on:
  workflow_call:

jobs:
  discover:
    name: "Discover build targets"
    runs-on: ubuntu-latest
    outputs:
      docker: ${{ steps.set.outputs.docker }}
      helm: ${{ steps.set.outputs.helm }}
    steps:
      - name: Checkout
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
        with:
          fetch-depth: 0
      - name: Find Docker & Helm targets
        id: set
        shell: bash
        run: |
          set -euo pipefail
          # Find Dockerfiles under apps/** (supports apps/foo/src/Dockerfile or apps/foo/Dockerfile)
          docker_json='[]'
          while IFS= read -r df; do
            dir="$(dirname "$df")"
            base="$(basename "$dir")"
            if [[ "$base" == "src" ]]; then
              name="$(basename "$(dirname "$dir")")"
              context="$dir"
            else
              name="$(basename "$dir")"
              context="$dir"
            fi
            docker_json="$(jq --arg n "$name" --arg c "$context" '. + [{name:$n, context:$c}]' <<<"$docker_json")"
          done < <(find apps -type f -iname Dockerfile | sort)

          # Find Helm charts as any apps/*/Chart.yaml (and apps/*/charts/<subchart>/Chart.yaml ignored)
          helm_json='[]'
          while IFS= read -r chart; do
            chart_dir="$(dirname "$chart")"
            # app name is the directory containing Chart.yaml
            name="$(basename "$chart_dir")"
            helm_json="$(jq --arg n "$name" --arg p "$chart_dir" '. + [{name:$n, path:$p}]' <<<"$helm_json")"
          done < <(find apps -maxdepth 2 -type f -name Chart.yaml | sort)

          event="${GITHUB_EVENT_NAME}"
          is_pr="false"
          if [[ "$event" == "pull_request" || "$event" == "pull_request_target" || "${GITHUB_REF}" == refs/pull/* ]]; then
            is_pr="true"
          fi

          if [[ "$is_pr" == "true" ]]; then
            if [[ -z "${GITHUB_BASE_REF:-}" ]]; then
              echo "No base ref available; building all discovered apps."
            else
              git fetch --no-tags origin "${GITHUB_BASE_REF}" --depth=1
              mapfile -t changed_files < <(git diff --name-only "origin/${GITHUB_BASE_REF}" HEAD || true)
              mapfile -t changed_apps < <(printf '%s\n' "${changed_files[@]}" | awk -F/ '($1=="apps" && $2!=""){print $2}' | sort -u)

              if (( ${#changed_apps[@]} )); then
                echo "Changed apps detected: ${changed_apps[*]}"
                apps_json="$(printf '%s\n' "${changed_apps[@]}" | jq -R . | jq -s 'map(select(length>0))')"
                docker_json="$(jq --argjson apps "$apps_json" 'map(select(.name as $n | ($apps | index($n))))' <<<"$docker_json")"
                helm_json="$(jq --argjson apps "$apps_json" 'map(select(.name as $n | ($apps | index($n))))' <<<"$helm_json")"
              else
                echo "No app changes detected on PR; skipping Docker and Helm builds."
                docker_json='[]'
                helm_json='[]'
              fi
            fi
          else
            echo "Non-PR event; building all discovered apps."
          fi

          echo "docker=$(jq -c . <<<"$docker_json")" >> "$GITHUB_OUTPUT"
          echo "helm=$(jq -c . <<<"$helm_json")" >> "$GITHUB_OUTPUT"

  docker:
    name: "Docker - ${{ matrix.name }}"
    needs: [discover]
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.discover.outputs.docker) }}
    steps:
      - name: Checkout
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0

      - name: Login to ghcr (Docker)
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3.6.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Get image tags
        id: meta
        uses: docker/metadata-action@318604b99e75e41977312d83839a89be02ca4893 # v5.9.0
        with:
          images: ghcr.io/homescalecloud/${{ matrix.name }}
          tags: |
            type=raw,value=${{ github.sha }}
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6.18.0
        with:
          context: ${{ matrix.context }}
          push: true
          cache-from: type=gha,scope=${{ matrix.name }}
          cache-to: type=gha,scope=${{ matrix.name }},mode=max
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          platforms: linux/amd64

      - name: Run Trivy scan
        uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8 # 0.33.1
        with:
          image-ref: ghcr.io/homescalecloud/${{ matrix.name }}:${{ github.sha }}
          format: 'table'
          exit-code: '1'
          ignore-unfixed: true
          vuln-type: 'os,library'
          severity: 'CRITICAL,HIGH'

  helm:
    name: "Helm â€“ ${{ matrix.name }}"
    needs: [discover, docker]
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.discover.outputs.helm) }}
    steps:
      - name: Checkout
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
      - name: Set up Helm
        uses: azure/setup-helm@1a275c3b69536ee54be43f2070a358922e12c8d4 # v4.3.1
        with:
          version: v3.18.6
      - name: Login to ghcr (Docker)
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3.6.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Login to ghcr (Helm OCI)
        shell: bash
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | helm registry login ghcr.io --username "${{ github.actor }}" --password-stdin
      - name: Get Helm dependencies
        run: |
          helm dependency build "${{ matrix.path }}"
      - name: Package Helm chart
        run: |
          helm package "${{ matrix.path }}"
      - name: Upload chart artifacts
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: helm-${{ matrix.name }}
          path: ./${{ matrix.name }}-*.tgz
          if-no-files-found: error
      - name: Push Helm chart (main only)
        if: github.ref == 'refs/heads/main'
        shell: bash
        run: |
          # Derive version without needing yq installed
          CHART_VERSION="$(helm show chart "${{ matrix.path }}" | awk '/^version:/{print $2}')"
          helm push "${{ matrix.name }}-${CHART_VERSION}.tgz" oci://ghcr.io/homescalecloud/helm
